#!/bin/bash

clear
echo -e "\n🔧 Discos disponíveis:"
lsblk -d -o NAME,SIZE,MODEL | grep -v loop
echo
read -rp "Digite o caminho do disco para instalação (ex: /dev/sda): " DISCO

if [[ ! -b "$DISCO" ]]; then
  echo -e "\n\e[31;1m[ERRO]\e[m Disco inválido: $DISCO"
  exit 1
fi

export DISCO

source funcoes.sh

clear
cat <<EOL
===============================================
🚀 Bem-vindo ao Instalador Arch Linux (UEFI + BTRFS)
===============================================

⚠️ Este instalador apagará TODO o conteúdo do disco: $DISCO

As seguintes partições serão criadas:
  • EFI        → $TAMANHO_EFI
  • ROOT (btrfs) → $TAMANHO_RAIZ com subvolumes:
     → /  /var  /tmp  /opt  /home
  • SWAP       → $TAMANHO_SWAP

Deseja continuar? [S/n]
EOL

read -n1 CONFIRMA
[[ "$CONFIRMA" != @(S|s) ]] && exit 0
clear

for i in "${!_msg[@]}"; do
  echo -en " $_y➜$_o ${_msg[$i]}"
  _run
  eval "${_cmd[$i]}" >> /tmp/etapa_$i.log 2>&1
  kill $pid && wait $pid

  if [[ $? -eq 0 ]]; then
    echo -e "$(_s 30)$_g✔$_o [ok]"
  else
    echo -e "$(_s 30)$_r✖$_o [erro]\nVerifique /tmp/etapa_$i.log"
    exit 1
  fi
done

cp config.sh /mnt/root/
cp pos_chroot.sh /mnt/root/
arch-chroot /mnt /root/pos_chroot.sh

_instalar_pacotes_adicionais

cat <<EOF

===============================================
🎉 INSTALAÇÃO FINALIZADA COM SUCESSO!
===============================================

✔ Sistema instalado em: $DISCO
✔ Subvolumes com compressão zstd
✔ Hostname: $HOSTNAME

💡 Agora você pode reiniciar o sistema.
➡️ Lembre-se de remover o ISO ou pendrive.

Pressione [ENTER] para reiniciar...
EOF

read -n1
reboot

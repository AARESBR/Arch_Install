#!/bin/bash

clear
echo -e "\nðŸ”§ Discos disponÃ­veis:"
lsblk -d -o NAME,SIZE,MODEL | grep -v loop
echo
read -rp "Digite o caminho do disco para instalaÃ§Ã£o (ex: /dev/sda): " DISCO

if [[ ! -b "$DISCO" ]]; then
  echo -e "\n\e[31;1m[ERRO]\e[m Disco invÃ¡lido: $DISCO"
  exit 1
fi

export DISCO

source funcoes.sh

clear
cat <<EOL
===============================================
ðŸš€ Bem-vindo ao Instalador Arch Linux (UEFI + BTRFS)
===============================================

âš ï¸ Este instalador apagarÃ¡ TODO o conteÃºdo do disco: $DISCO

As seguintes partiÃ§Ãµes serÃ£o criadas:
  â€¢ EFI        â†’ $TAMANHO_EFI
  â€¢ ROOT (btrfs) â†’ $TAMANHO_RAIZ com subvolumes:
     â†’ /  /var  /tmp  /opt  /home
  â€¢ SWAP       â†’ $TAMANHO_SWAP

Deseja continuar? [S/n]
EOL

read -n1 CONFIRMA
[[ "$CONFIRMA" != @(S|s) ]] && exit 0
clear

for i in "${!_msg[@]}"; do
  echo -en " $_yâžœ$_o ${_msg[$i]}"
  _run
  eval "${_cmd[$i]}" >> /tmp/etapa_$i.log 2>&1
  kill $pid && wait $pid

  if [[ $? -eq 0 ]]; then
    echo -e "$(_s 30)$_gâœ”$_o [ok]"
  else
    echo -e "$(_s 30)$_râœ–$_o [erro]\nVerifique /tmp/etapa_$i.log"
    exit 1
  fi
done

cp config.sh /mnt/root/
cp pos_chroot.sh /mnt/root/
arch-chroot /mnt /root/pos_chroot.sh

_instalar_pacotes_adicionais

cat <<EOF

===============================================
ðŸŽ‰ INSTALAÃ‡ÃƒO FINALIZADA COM SUCESSO!
===============================================

âœ” Sistema instalado em: $DISCO
âœ” Subvolumes com compressÃ£o zstd
âœ” Hostname: $HOSTNAME

ðŸ’¡ Agora vocÃª pode reiniciar o sistema.
âž¡ï¸ Lembre-se de remover o ISO ou pendrive.

Pressione [ENTER] para reiniciar...
EOF

read -n1
reboot
